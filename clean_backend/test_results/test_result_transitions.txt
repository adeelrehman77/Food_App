Using development SYNC_TOKEN. Set SYNC_TOKEN environment variable in production.
Using development ENCRYPTION_KEY. Set ENCRYPTION_KEY env var in production.
============================= test session starts ==============================
platform darwin -- Python 3.14.2, pytest-7.4.4, pluggy-1.6.0
django: version: 4.2.28, settings: config.settings.test (from ini)
rootdir: /Users/adeelrehman/Food_App/clean_backend
configfile: pytest.ini
plugins: cov-4.1.0, Faker-40.4.0, django-4.11.1
collected 4 items

apps/main/tests/test_order_status_transitions.py EEEE

==================================== ERRORS ====================================
_ ERROR at setup of TestOrderStatusTransitions.test_cannot_transition_to_preparing_before_today _

self = <main.tests.test_order_status_transitions.TestOrderStatusTransitions object at 0x109e0b890>

    def setup_method(self):
        self.tenant = Tenant.objects.create(
            name="Test",
            subdomain="test",
            is_active=True
        )
        self.user = apps.get_model('auth', 'User').objects.create_user(username='testclient')
        self.profile = apps.get_model('main', 'CustomerProfile').objects.create(user=self.user, tenant_id=self.tenant.id)
    
        # Create required subscription dependencies
        self.package = MealPackage.objects.create(name="Standard", price=100)
>       self.subscription = Subscription.objects.create(
            customer=self.profile,
            meal_package=self.package,
            start_date=date.today(),
            end_date=date.today() + timedelta(days=30),
            status='active'
        )

apps/main/tests/test_order_status_transitions.py:24: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.14/site-packages/django/db/models/manager.py:87: in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
.venv/lib/python3.14/site-packages/django/db/models/query.py:660: in create
    obj.save(force_insert=True, using=self.db)
apps/main/models.py:684: in save
    self.full_clean()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Subscription: Subscription for  from 2026-02-14 to 2026-03-16>
exclude = {'selected_days'}, validate_unique = True, validate_constraints = True

    def full_clean(self, exclude=None, validate_unique=True, validate_constraints=True):
        """
        Call clean_fields(), clean(), validate_unique(), and
        validate_constraints() on the model. Raise a ValidationError for any
        errors that occur.
        """
        errors = {}
        if exclude is None:
            exclude = set()
        else:
            exclude = set(exclude)
    
        try:
            self.clean_fields(exclude=exclude)
        except ValidationError as e:
            errors = e.update_error_dict(errors)
    
        # Form.clean() is run even if other validation fails, so do the
        # same with Model.clean() for consistency.
        try:
            self.clean()
        except ValidationError as e:
            errors = e.update_error_dict(errors)
    
        # Run unique checks, but only for fields that passed validation.
        if validate_unique:
            for name in errors:
                if name != NON_FIELD_ERRORS and name not in exclude:
                    exclude.add(name)
            try:
                self.validate_unique(exclude=exclude)
            except ValidationError as e:
                errors = e.update_error_dict(errors)
    
        # Run constraints checks, but only for fields that passed validation.
        if validate_constraints:
            for name in errors:
                if name != NON_FIELD_ERRORS and name not in exclude:
                    exclude.add(name)
            try:
                self.validate_constraints(exclude=exclude)
            except ValidationError as e:
                errors = e.update_error_dict(errors)
    
        if errors:
>           raise ValidationError(errors)
E           django.core.exceptions.ValidationError: {'selected_days': ['This field cannot be blank.', 'At least one day must be selected.']}

.venv/lib/python3.14/site-packages/django/db/models/base.py:1502: ValidationError
_ ERROR at setup of TestOrderStatusTransitions.test_can_transition_to_preparing_on_delivery_day _

self = <main.tests.test_order_status_transitions.TestOrderStatusTransitions object at 0x109e0bc50>

    def setup_method(self):
        self.tenant = Tenant.objects.create(
            name="Test",
            subdomain="test",
            is_active=True
        )
        self.user = apps.get_model('auth', 'User').objects.create_user(username='testclient')
        self.profile = apps.get_model('main', 'CustomerProfile').objects.create(user=self.user, tenant_id=self.tenant.id)
    
        # Create required subscription dependencies
        self.package = MealPackage.objects.create(name="Standard", price=100)
>       self.subscription = Subscription.objects.create(
            customer=self.profile,
            meal_package=self.package,
            start_date=date.today(),
            end_date=date.today() + timedelta(days=30),
            status='active'
        )

apps/main/tests/test_order_status_transitions.py:24: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.14/site-packages/django/db/models/manager.py:87: in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
.venv/lib/python3.14/site-packages/django/db/models/query.py:660: in create
    obj.save(force_insert=True, using=self.db)
apps/main/models.py:684: in save
    self.full_clean()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Subscription: Subscription for  from 2026-02-14 to 2026-03-16>
exclude = {'selected_days'}, validate_unique = True, validate_constraints = True

    def full_clean(self, exclude=None, validate_unique=True, validate_constraints=True):
        """
        Call clean_fields(), clean(), validate_unique(), and
        validate_constraints() on the model. Raise a ValidationError for any
        errors that occur.
        """
        errors = {}
        if exclude is None:
            exclude = set()
        else:
            exclude = set(exclude)
    
        try:
            self.clean_fields(exclude=exclude)
        except ValidationError as e:
            errors = e.update_error_dict(errors)
    
        # Form.clean() is run even if other validation fails, so do the
        # same with Model.clean() for consistency.
        try:
            self.clean()
        except ValidationError as e:
            errors = e.update_error_dict(errors)
    
        # Run unique checks, but only for fields that passed validation.
        if validate_unique:
            for name in errors:
                if name != NON_FIELD_ERRORS and name not in exclude:
                    exclude.add(name)
            try:
                self.validate_unique(exclude=exclude)
            except ValidationError as e:
                errors = e.update_error_dict(errors)
    
        # Run constraints checks, but only for fields that passed validation.
        if validate_constraints:
            for name in errors:
                if name != NON_FIELD_ERRORS and name not in exclude:
                    exclude.add(name)
            try:
                self.validate_constraints(exclude=exclude)
            except ValidationError as e:
                errors = e.update_error_dict(errors)
    
        if errors:
>           raise ValidationError(errors)
E           django.core.exceptions.ValidationError: {'selected_days': ['This field cannot be blank.', 'At least one day must be selected.']}

.venv/lib/python3.14/site-packages/django/db/models/base.py:1502: ValidationError
_ ERROR at setup of TestOrderStatusTransitions.test_cannot_transition_to_ready_before_today _

self = <main.tests.test_order_status_transitions.TestOrderStatusTransitions object at 0x109ea6650>

    def setup_method(self):
        self.tenant = Tenant.objects.create(
            name="Test",
            subdomain="test",
            is_active=True
        )
        self.user = apps.get_model('auth', 'User').objects.create_user(username='testclient')
        self.profile = apps.get_model('main', 'CustomerProfile').objects.create(user=self.user, tenant_id=self.tenant.id)
    
        # Create required subscription dependencies
        self.package = MealPackage.objects.create(name="Standard", price=100)
>       self.subscription = Subscription.objects.create(
            customer=self.profile,
            meal_package=self.package,
            start_date=date.today(),
            end_date=date.today() + timedelta(days=30),
            status='active'
        )

apps/main/tests/test_order_status_transitions.py:24: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.14/site-packages/django/db/models/manager.py:87: in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
.venv/lib/python3.14/site-packages/django/db/models/query.py:660: in create
    obj.save(force_insert=True, using=self.db)
apps/main/models.py:684: in save
    self.full_clean()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Subscription: Subscription for  from 2026-02-14 to 2026-03-16>
exclude = {'selected_days'}, validate_unique = True, validate_constraints = True

    def full_clean(self, exclude=None, validate_unique=True, validate_constraints=True):
        """
        Call clean_fields(), clean(), validate_unique(), and
        validate_constraints() on the model. Raise a ValidationError for any
        errors that occur.
        """
        errors = {}
        if exclude is None:
            exclude = set()
        else:
            exclude = set(exclude)
    
        try:
            self.clean_fields(exclude=exclude)
        except ValidationError as e:
            errors = e.update_error_dict(errors)
    
        # Form.clean() is run even if other validation fails, so do the
        # same with Model.clean() for consistency.
        try:
            self.clean()
        except ValidationError as e:
            errors = e.update_error_dict(errors)
    
        # Run unique checks, but only for fields that passed validation.
        if validate_unique:
            for name in errors:
                if name != NON_FIELD_ERRORS and name not in exclude:
                    exclude.add(name)
            try:
                self.validate_unique(exclude=exclude)
            except ValidationError as e:
                errors = e.update_error_dict(errors)
    
        # Run constraints checks, but only for fields that passed validation.
        if validate_constraints:
            for name in errors:
                if name != NON_FIELD_ERRORS and name not in exclude:
                    exclude.add(name)
            try:
                self.validate_constraints(exclude=exclude)
            except ValidationError as e:
                errors = e.update_error_dict(errors)
    
        if errors:
>           raise ValidationError(errors)
E           django.core.exceptions.ValidationError: {'selected_days': ['This field cannot be blank.', 'At least one day must be selected.']}

.venv/lib/python3.14/site-packages/django/db/models/base.py:1502: ValidationError
_ ERROR at setup of TestOrderStatusTransitions.test_auto_creates_delivery_when_marked_ready _

self = <main.tests.test_order_status_transitions.TestOrderStatusTransitions object at 0x109ea6780>

    def setup_method(self):
        self.tenant = Tenant.objects.create(
            name="Test",
            subdomain="test",
            is_active=True
        )
        self.user = apps.get_model('auth', 'User').objects.create_user(username='testclient')
        self.profile = apps.get_model('main', 'CustomerProfile').objects.create(user=self.user, tenant_id=self.tenant.id)
    
        # Create required subscription dependencies
        self.package = MealPackage.objects.create(name="Standard", price=100)
>       self.subscription = Subscription.objects.create(
            customer=self.profile,
            meal_package=self.package,
            start_date=date.today(),
            end_date=date.today() + timedelta(days=30),
            status='active'
        )

apps/main/tests/test_order_status_transitions.py:24: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
.venv/lib/python3.14/site-packages/django/db/models/manager.py:87: in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
.venv/lib/python3.14/site-packages/django/db/models/query.py:660: in create
    obj.save(force_insert=True, using=self.db)
apps/main/models.py:684: in save
    self.full_clean()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <Subscription: Subscription for  from 2026-02-14 to 2026-03-16>
exclude = {'selected_days'}, validate_unique = True, validate_constraints = True

    def full_clean(self, exclude=None, validate_unique=True, validate_constraints=True):
        """
        Call clean_fields(), clean(), validate_unique(), and
        validate_constraints() on the model. Raise a ValidationError for any
        errors that occur.
        """
        errors = {}
        if exclude is None:
            exclude = set()
        else:
            exclude = set(exclude)
    
        try:
            self.clean_fields(exclude=exclude)
        except ValidationError as e:
            errors = e.update_error_dict(errors)
    
        # Form.clean() is run even if other validation fails, so do the
        # same with Model.clean() for consistency.
        try:
            self.clean()
        except ValidationError as e:
            errors = e.update_error_dict(errors)
    
        # Run unique checks, but only for fields that passed validation.
        if validate_unique:
            for name in errors:
                if name != NON_FIELD_ERRORS and name not in exclude:
                    exclude.add(name)
            try:
                self.validate_unique(exclude=exclude)
            except ValidationError as e:
                errors = e.update_error_dict(errors)
    
        # Run constraints checks, but only for fields that passed validation.
        if validate_constraints:
            for name in errors:
                if name != NON_FIELD_ERRORS and name not in exclude:
                    exclude.add(name)
            try:
                self.validate_constraints(exclude=exclude)
            except ValidationError as e:
                errors = e.update_error_dict(errors)
    
        if errors:
>           raise ValidationError(errors)
E           django.core.exceptions.ValidationError: {'selected_days': ['This field cannot be blank.', 'At least one day must be selected.']}

.venv/lib/python3.14/site-packages/django/db/models/base.py:1502: ValidationError
=============================== warnings summary ===============================
.venv/lib/python3.14/site-packages/django/conf/__init__.py:289
  /Users/adeelrehman/Food_App/clean_backend/.venv/lib/python3.14/site-packages/django/conf/__init__.py:289: RemovedInDjango51Warning: The STATICFILES_STORAGE setting is deprecated. Use STORAGES instead.
    warnings.warn(STATICFILES_STORAGE_DEPRECATED_MSG, RemovedInDjango51Warning)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html

---------- coverage: platform darwin, python 3.14.2-final-0 ----------
Name                                                                                               Stmts   Miss  Cover   Missing
--------------------------------------------------------------------------------------------------------------------------------
apps/delivery/__init__.py                                                                              0      0   100%
apps/delivery/admin.py                                                                                 9      0   100%
apps/delivery/apps.py                                                                                  4      0   100%
apps/delivery/migrations/0001_initial.py                                                               7      0   100%
apps/delivery/migrations/0002_update_delivery_driver.py                                                6      0   100%
apps/delivery/migrations/__init__.py                                                                   0      0   100%
apps/delivery/models.py                                                                               22      6    73%   33, 38-42
apps/driver/__init__.py                                                                                0      0   100%
apps/driver/admin.py                                                                                  35      0   100%
apps/driver/apps.py                                                                                    4      0   100%
apps/driver/migrations/0001_initial.py                                                                 7      0   100%
apps/driver/migrations/0002_deliveryassignment_deliverydriver_and_more.py                              7      0   100%
apps/driver/migrations/0003_add_zones_routes_to_deliverydriver.py                                      4      0   100%
apps/driver/migrations/0004_deliverydriver_user.py                                                     6      0   100%
apps/driver/migrations/__init__.py                                                                     0      0   100%
apps/driver/models.py                                                                                118     21    82%   27, 48, 96, 102-117, 123-132, 174, 201, 237, 276
apps/inventory/__init__.py                                                                             0      0   100%
apps/inventory/admin.py                                                                               12      0   100%
apps/inventory/apps.py                                                                                 4      0   100%
apps/inventory/migrations/0001_initial.py                                                              6      0   100%
apps/inventory/migrations/0002_alter_inventoryitem_options_and_more.py                                 4      0   100%
apps/inventory/migrations/__init__.py                                                                  0      0   100%
apps/inventory/models.py                                                                              31      3    90%   22, 52, 56
apps/kitchen/__init__.py                                                                               0      0   100%
apps/kitchen/admin.py                                                                                 12      0   100%
apps/kitchen/apps.py                                                                                   4      0   100%
apps/kitchen/migrations/0001_initial.py                                                                7      0   100%
apps/kitchen/migrations/__init__.py                                                                    0      0   100%
apps/kitchen/models.py                                                                                22      2    91%   15, 28
apps/main/__init__.py                                                                                  0      0   100%
apps/main/admin.py                                                                                    55      0   100%
apps/main/apps.py                                                                                      4      0   100%
apps/main/management/__init__.py                                                                       0      0   100%
apps/main/migrations/0001_initial.py                                                                   7      0   100%
apps/main/migrations/0002_wallettransaction_address.py                                                 5      0   100%
apps/main/migrations/0003_customerprofile_notification_remove_customer_tenant_and_more.py              7      0   100%
apps/main/migrations/0004_customerregistrationrequest_invoice_invoiceitem_and_more.py                  8      0   100%
apps/main/migrations/0005_alter_menuitem_options_remove_customerprofile_tenant_and_more.py             5      0   100%
apps/main/migrations/0006_daily_menu_system.py                                                         6      0   100%
apps/main/migrations/0007_add_diet_type_and_meal_package.py                                            4      0   100%
apps/main/migrations/0008_fix_created_by_cross_db.py                                                   4      0   100%
apps/main/migrations/0009_revert_created_by_to_fk.py                                                   6      0   100%
apps/main/migrations/0010_subscription_diet_type.py                                                    4      0   100%
apps/main/migrations/0011_subscription_use_mealslot.py                                                 5      0   100%
apps/main/migrations/0012_mealpackage_menus_subscription_meal_package.py                               5      0   100%
apps/main/migrations/0013_invoice_number_optional.py                                                   4      0   100%
apps/main/migrations/0014_add_zone_to_address.py                                                       5      0   100%
apps/main/migrations/__init__.py                                                                       0      0   100%
apps/main/models.py                                                                                  480    167    65%   23-28, 40, 55, 136, 140, 184, 200, 232, 291, 296, 336, 341-343, 428-429, 485-489, 492-510, 513-524, 527-540, 543-556, 626-628, 632-639, 648-655, 664, 666, 672-680, 685-688, 691-715, 724-740, 749-772, 798, 809, 812, 827, 830-834, 845, 863, 877, 880-898, 918, 930, 937
apps/main/tests/__init__.py                                                                            0      0   100%
apps/main/tests/test_order_status_transitions.py                                                      43     24    44%   32, 43-56, 61-69, 74-87, 92-103
apps/main/utils/__init__.py                                                                            1      0   100%
apps/main/utils/validators.py                                                                         20     11    45%   5-7, 10, 13, 16-18, 21, 24, 27
apps/organizations/__init__.py                                                                         0      0   100%
apps/organizations/admin.py                                                                           28      0   100%
apps/organizations/apps.py                                                                             4      0   100%
apps/organizations/management/__init__.py                                                              0      0   100%
apps/organizations/migrations/0001_initial.py                                                          5      0   100%
apps/organizations/migrations/0002_rename_subscriptionplan_serviceplan.py                              4      0   100%
apps/organizations/migrations/0003_remove_serviceplan_max_orders_per_month.py                          4      0   100%
apps/organizations/migrations/0004_alter_serviceplan_options_serviceplan_description_and_more.py       6      0   100%
apps/organizations/migrations/0005_alter_serviceplan_max_customers_and_more.py                         4      0   100%
apps/organizations/migrations/__init__.py                                                              0      0   100%
apps/organizations/models.py                                                                          39     10    74%   75, 80-84, 91-95
apps/organizations/models_saas.py                                                                     76     16    79%   62, 66, 70, 74-76, 122, 125-135, 166
apps/users/__init__.py                                                                                 0      0   100%
apps/users/admin.py                                                                                   15      0   100%
apps/users/apps.py                                                                                     6      0   100%
apps/users/migrations/0001_initial.py                                                                  7      0   100%
apps/users/migrations/0002_rename_subscription_plan_tenant_service_plan.py                             4      0   100%
apps/users/migrations/0003_add_tenant_to_userprofile.py                                                5      0   100%
apps/users/migrations/__init__.py                                                                      0      0   100%
apps/users/models.py                                                                                  31      3    90%   21, 30, 49
apps/users/signals.py                                                                                 31     14    55%   25, 36-70
config/__init__.py                                                                                     0      0   100%
config/asgi.py                                                                                         7      7     0%   10-19
config/settings/__init__.py                                                                            0      0   100%
config/settings/base.py                                                                              200     40    80%   32, 336-339, 348-349, 355-368, 467-470, 483, 509, 564-571, 580, 585-593, 599, 604-605, 649-650
config/settings/development.py                                                                        25     25     0%   1-63
config/settings/production.py                                                                         45     45     0%   1-85
config/settings/test.py                                                                               22      0   100%
config/url_patterns/__init__.py                                                                        0      0   100%
config/url_patterns/base.py                                                                           14     14     0%   1-57
config/urls.py                                                                                        13     13     0%   1-64
config/wsgi.py                                                                                         4      4     0%   10-16
core/__init__.py                                                                                       0      0   100%
core/db/router.py                                                                                     24      3    88%   14, 58, 75
core/middleware/__init__.py                                                                            3      3     0%   2-19
core/middleware/multi_db_tenant.py                                                                    38     38     0%   1-87
core/middleware/performance.py                                                                       164    164     0%   1-316
core/middleware/security.py                                                                          137    137     0%   1-297
core/middleware/tenant.py                                                                             28     28     0%   1-52
core/monitoring/__init__.py                                                                           16     16     0%   2-32
core/permissions/__init__.py                                                                           2      2     0%   2-3
core/permissions/custom.py                                                                            74     74     0%   1-215
core/permissions/plan_limits.py                                                                       48     48     0%   11-99
core/tests/__init__.py                                                                                 0      0   100%
core/tests/test_middleware.py                                                                         31     31     0%   1-35
core/tests/test_validators.py                                                                         56     56     0%   1-76
core/utils/__init__.py                                                                                 0      0   100%
core/utils/validators.py                                                                             124    124     0%   1-215
create_tenant_user.py                                                                                 38     38     0%   1-57
fix_drivers.py                                                                                        58     58     0%   1-100
fix_tenant.py                                                                                         41     41     0%   5-56
manage.py                                                                                             11     11     0%   3-22
scripts/__init__.py                                                                                    0      0   100%
scripts/create_api_key.py                                                                             47     47     0%   14-87
scripts/fix_migrations.py                                                                             15     15     0%   1-20
scripts/inspect_db.py                                                                                 15     15     0%   1-17
scripts/provision_tenant.py                                                                           49     49     0%   1-98
scripts/reset_local_schema.py                                                                         29     29     0%   1-54
scripts/setup_database.py                                                                             45     45     0%   11-120
--------------------------------------------------------------------------------------------------------------------------------
TOTAL                                                                                               2701   1497    45%

=========================== short test summary info ============================
ERROR apps/main/tests/test_order_status_transitions.py::TestOrderStatusTransitions::test_cannot_transition_to_preparing_before_today
ERROR apps/main/tests/test_order_status_transitions.py::TestOrderStatusTransitions::test_can_transition_to_preparing_on_delivery_day
ERROR apps/main/tests/test_order_status_transitions.py::TestOrderStatusTransitions::test_cannot_transition_to_ready_before_today
ERROR apps/main/tests/test_order_status_transitions.py::TestOrderStatusTransitions::test_auto_creates_delivery_when_marked_ready
========================= 1 warning, 4 errors in 4.75s =========================
